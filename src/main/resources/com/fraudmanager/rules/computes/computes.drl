package com.fraudmanager.rules.computes;

import com.fraudmanager.flink.model.Measurment;
import ma.s2m.auth.ITransaction;
import com.fraudmanager.flink.utils.TimeConversion;
import org.apache.flink.streaming.api.windowing.time.Time;
import com.fraudmanager.flink.model.ExternalSystem;
import java.util.List;
import java.util.Arrays;
import java.time.Duration;
import java.time.LocalDate;
import com.fraudmanager.flink.utils.Utils;
import com.fraudmanager.flink.model.computation.MeasurmentRecord;
import com.fraudmanager.flink.model.computation.RecordHashMap;
import com.fraudmanager.flink.model.computation.Subject;
import ma.s2m.auth.Alert;
import ma.medtech.droolbuilder.messaging.IMessageSender;
import ma.medtech.droolbuilder.services.TypeConverter;

global TimeConversion timeConverter;
global ExternalSystem externalSystem;
global IMessageSender messageSender;
global TypeConverter typeConverter;

rule "(Rule Type COMPUTE) COMPUTE NUMBER OF TRANSACTIONS WITH THE SAME AMOUNT WITH THE SAME MERCHANT"
no-loop true
lock-on-active true
salience 1000
agenda-group "Card->1 minute"
when
$measurment: Measurment($amount: transaction.amount, $merchant: transaction.merchant)
    
    eval($amount != null)
    eval($merchant != null)
    $key0: String() from "COUNT".concat("_OF").concat("_TRANSACTION").concat("_ALL").concat("_").concat($merchant.toString()).concat("_").concat($amount.toString())
    $record: MeasurmentRecord() from $measurment.getRecords().get($key0)
    Measurment()
then
$record.setCount($record.getCount() + 1);
$measurment.getRecords().put("COUNT_OF_TRANSACTION_ALL_" + $merchant+ "_" + $amount, $record);;
update($measurment);
end

rule "(Rule Type ALERT) ALERT IF 2L TRANSACTIONS IN DIFFERENT COUNTRIES WITHIN 5 hour(s)"
no-loop true

salience 200
agenda-group "Card->5 hours"
when
$measurment: Measurment($record: records.get("COUNT_OF_COUNTRY_CHANGES"), $record.count>=2L)
then
Alert alert = new Alert("Alert: Count of country changes within 5 hour(s) exceeded 2L",Alert.POSITIVE);
alert.setWeight(100);;
alert.setRuleTitle("ALERT IF 2L TRANSACTIONS IN DIFFERENT COUNTRIES WITHIN 5 hour(s)");;
alert.setTotalAmount($record.getAmount());
alert.setTotalCount($record.getCount());
$measurment.getAlertSet().addAlert(alert);;
update($measurment);
end

rule "(Rule Type ALERT) ALERT More than 12 transactions with Response Code 161 (Max Transaction Amount Exceeded) of type 5000 (Sales Draft) at MCC 3641 (Sofitel Hotels) in Iraq (999) via Payment Channel online using Contactless within 1 hour."
no-loop true

salience 200
agenda-group "Card->1 hour"
when
$measurment: Measurment($record: records.get("COUNT_OF_TRANSACTION_ALL_R012"), $merchant: transaction.merchant, $record.count>=12L)
then
messageSender.send("Alert: More than 12L transactions with Response Code 161 (Max Transaction Amount Exceeded) at " + $merchant + ", TranCode=5000, MCC=3641 (Sofitel Hotels), Country=Iraq (999), Support=Contactless within 1 hour(s)",Alert.POSITIVE);
update($measurment);
end

rule "(Rule Type COMPUTE) COMPUTE More than 5 transactions by card detected in 4 different countries within 1 day"
no-loop true
lock-on-active true
salience 1000
agenda-group "Card->1 day"
when
$measurment: Measurment($record: records.get("COUNT_OF_TRANSACTION_ALL_R019"), $card: transaction.autPrimAcctNumbF002, $country: transaction.autAcqrInstCounCodeF019, ($country=="400", $country=="466", $country=="999" && $country=="050"))
then
$record.setCount($record.getCount() + 1);
$measurment.getRecords().put("COUNT_OF_TRANSACTION_ALL_R019", $record);;
update($measurment);
end

rule "(Rule Type COMPUTE) COMPUTE More than 40 transactions of type 21013 (Account Transfer) at  MCC 3177 (Airtan Airways) in Bangladesh (050) using Contactless within 1 month."
no-loop true
lock-on-active true
salience 1000
agenda-group "Merchant->1 month"
when
$measurment: Measurment($record: records.get("COUNT_OF_TRANSACTION_ALL_R005"), $merchant: transaction.merchant, transaction.merchant==$merchant, transaction.autTranCode=="21013", transaction.autMercTypeF018=="3177", transaction.autAcqrInstCounCodeF019=="050", transaction.autCardEntrCapaF22_01=="3", transaction.autRespCodeF039=="000")
then
$record.setCount($record.getCount() + 1);
$measurment.getRecords().put("COUNT_OF_TRANSACTION_ALL_R005", $record);;
update($measurment);
end

rule "(Rule Type ALERT) ALERT More than 8 transactions with Response Code 275 (PIN Try Limit Exceeded) of type 7000 (Cash Disbursement ATM) at MCC 6011 (ATM) in Jordan (400) via Payment Channel ATM using Puce within 15 minutes."
no-loop true

salience 200
agenda-group "Card->15 minutes"
when
$measurment: Measurment($record: records.get("COUNT_OF_TRANSACTION_ALL_R011"), $merchant: transaction.merchant, $record.count>=8L)
then
messageSender.send("Alert: More than 8L transactions with Response Code 275 (PIN Try Limit Exceeded) at " + $merchant + ", TranCode=7000, MCC=6011 (ATM), Country=Jordan (400), Support=Puce within 15 minute(s)",Alert.POSITIVE);
update($measurment);
end

rule "(Rule Type COMPUTE) COMPUTE More than 3 Cash Disbursement ATM transactions  by card detected in 3 different countries (Jordan, Kazakhstan, Morocco)  within 1hour"
no-loop true
lock-on-active true
salience 1000
agenda-group "Card->1 hour"
when
$measurment: Measurment($record: records.get("COUNT_OF_TRANSACTION_ALL_R018"), $card: transaction.autPrimAcctNumbF002, $country: transaction.autAcqrInstCounCodeF019, transaction.autTranCode=="7000", ($country=="400", $country==" 398" && $country=="504"))
then
$record.setCount($record.getCount() + 1);
$measurment.getRecords().put("COUNT_OF_TRANSACTION_ALL_R018", $record);;
update($measurment);
end

rule "(Rule Type ALERT) ALERT IF TOTAL AUTHORIZATION VALUE EXCEEDS 20000.0 IN 1 hour(s) IN SPECIFIC COUNTRIES"
no-loop true

salience 200
agenda-group "Card->1 hour"
when
$measurment: Measurment($record: records.get("AMOUNT_OF_TRANSACTION_ALL_SPECIFIC_COUNTRIES"), $record.amount>=20000.0)
then
Alert alert = new Alert("Alert: total auth value exceeded 20000.0 within 1 hour(s) in specific countries",Alert.POSITIVE);
alert.setWeight(300);;
alert.setRuleTitle("ALERT IF TOTAL AUTHORIZATION VALUE EXCEEDS 20000.0 IN 1 hour(s) IN SPECIFIC COUNTRIES");;
alert.setTotalAmount($record.getAmount());
alert.setTotalCount($record.getCount());
$measurment.getAlertSet().addAlert(alert);;
update($measurment);
end

rule "(Rule Type COMPUTE) COMPUTE TOTAL NUMBER OF POS 02 TRANSACTIONS RECEIVED IN A 10 second(s) TIME"
no-loop true
lock-on-active true
salience 1000
agenda-group "Card->10 seconds"
when
$measurment: Measurment($record: records.get("COUNT_OF_TRANSACTION_ALL_POS02"), $inpMode: transaction.autCardDataInptModeF22_09, Arrays.asList("2","9").contains($inpMode), transaction.autRespCodeF039=="000")
then
$record.setCount($record.getCount() + 1);
$measurment.getRecords().put("COUNT_OF_TRANSACTION_ALL_POS02", $record);;
update($measurment);
end

rule "(Rule Type ALERT) ALERT More than 10 transactions by card  detected in 5 different countries (Jordan, Kazakhstan, UAE, Morocco, Bolivia)  within 5hours"
no-loop true

salience 200
agenda-group "Card->5 hours"
when
$measurment: Measurment($record: records.get("COUNT_OF_TRANSACTION_ALL_R020"), $card: transaction.autPrimAcctNumbF002, $record.count>=10L)
then
messageSender.send("Alert: More than 10L transactions by card " + $card + " detected in 5 different countries (Jordan, Kazakhstan, UAE, Morocco, Bolivia) within 5 hour(s)",Alert.POSITIVE);
update($measurment);
end

rule "(Rule Type ALERT) ALERT PIN Try Limit Exceeded ON Salary Withdrawal POS (Morocco)"
no-loop true

salience 200
agenda-group "Card->15 minutes"
when
$measurment: Measurment($record: records.get("COUNT_OF_TRANSACTION_ALL_R015"), $merchant: transaction.merchant, $record.count>=10L)
then
messageSender.send("Alert: More than 10L transactions with Response Code 275 (PIN Try Limit Exceeded) at " + $merchant + ", TranCode=7007 (Salary Withdrawal POS), MCC=3260 (Spirit Air), Country=Morocco (504), currency with (MAD) Support=Puce within 15 minute(s)",Alert.POSITIVE);
update($measurment);
end

rule "(Rule Type ALERT) ALERT IF NUMBER OF TRX WITH THE SAME MERCHANT EXCEEDED 10L WITHIN 1 hour(s)"
no-loop true

salience 200
agenda-group "Card->1 hour"
when
$measurment: Measurment($merchant: transaction.merchant)
    
    eval($merchant != null)
    $key0: String() from "COUNT".concat("_OF").concat("_TRANSACTION").concat("_ALL").concat("_").concat($merchant.toString())
    $record: MeasurmentRecord() from $measurment.getRecords().get($key0)
    Measurment($record.count>=10L)
then
Alert alert = new Alert("Alert: Count of transactions with merchant " + $merchant + " exceeded 10L within 1 hour(s)",Alert.POSITIVE);
alert.setWeight(100);;
alert.setRuleTitle("ALERT IF NUMBER OF TRX WITH THE SAME MERCHANT EXCEEDED 10L WITHIN 1 hour(s)");;
alert.setTotalAmount($record.getAmount());
alert.setTotalCount($record.getCount());
$measurment.getAlertSet().addAlert(alert);;
update($measurment);
end

rule "(Rule Type ALERT) ALERT More than 20 transactions by card  detected in 4 different countries (Jordan, Kazakhstan, UAE, Morocco) within 1 week"
no-loop true

salience 200
agenda-group "Card->7 days"
when
$measurment: Measurment($record: records.get("COUNT_OF_TRANSACTION_ALL_R022"), $card: transaction.autPrimAcctNumbF002, $record.count>=20L)
then
messageSender.send("Alert: More than 20L transactions by card " + $card + " detected in 4 different countries (Jordan, Kazakhstan, UAE, Morocco) within 7 day(s)",Alert.POSITIVE);
update($measurment);
end

rule "(Rule Type ALERT) ALERT IF TOTAL AUTHORIZATION VALUE EXCEEDS 5000.0 IN 10 minute(s) PERIOD IN SPECIFIC MCC'S"
no-loop true

salience 200
agenda-group "Card->10 minutes"
when
$measurment: Measurment($record: records.get("AMOUNT_OF_TRANSACTION_ALL_SPECIFICMCC"), $record.amount>=5000.0)
then
Alert alert = new Alert("Alert: Total value of auth exceeded 5000.0 in 10 minute(s) in specific MCCs",Alert.POSITIVE);
alert.setWeight(200);;
alert.setRuleTitle("ALERT IF TOTAL AUTHORIZATION VALUE EXCEEDS 5000.0 IN 10 minute(s) PERIOD IN SPECIFIC MCC'S");;
alert.setTotalAmount($record.getAmount());
alert.setTotalCount($record.getCount());
$measurment.getAlertSet().addAlert(alert);;
update($measurment);
end

rule "(Rule Type COMPUTE) COMPUTE TOTAL NUMBER OF INVALID PIN ATTEMPTS EXCEEDS 5L IN 1 minute(s) PERIOD"
no-loop true
lock-on-active true
salience 1000
agenda-group "Card->1 minute"
when
$measurment: Measurment($record: records.get("COUNT_OF_TRANSACTION_ALL_INVALIDPIN_ATTEMPTS"), $respCode: transaction.autRespCodeF039, Arrays.asList("155","275").contains($respCode))
then
$record.setCount($record.getCount() + 1);
$measurment.getRecords().put("COUNT_OF_TRANSACTION_ALL_INVALIDPIN_ATTEMPTS", $record);;
update($measurment);
end

rule "(Rule Type ALERT) ALERT PIN Error sur Cash Disbursement ATM (Dubai, UAE)"
no-loop true

salience 200
agenda-group "Card->1 hour"
when
$measurment: Measurment($record: records.get("COUNT_OF_TRANSACTION_ALL_R016"), $merchant: transaction.merchant, $record.count>=15L)
then
messageSender.send("Alert: More than 15L transactions with Response Code 155 (PIN Error) at " + $merchant + ", TranCode=7000 (Cash Disbursement ATM), MCC=6011 (ATM), Country=UAE (466), Support=Piste within 1 hour(s)",Alert.POSITIVE);
update($measurment);
end

rule "(Rule Type COMPUTE) COMPUTE More than 70 transactions with Response Code 155 (PIN Error)  of type 5000 (Sales Draft) at MCC 3519 (Pullman International Hotels) in Kazakhstan (398) using Puce within 24 hours."
no-loop true
lock-on-active true
salience 1000
agenda-group "Card->1 day"
when
$measurment: Measurment($record: records.get("COUNT_OF_TRANSACTION_ALL_R013"), $merchant: transaction.merchant, transaction.merchant==$merchant, transaction.merchant==$merchant, transaction.autMercTypeF018=="3519", transaction.autAcqrInstCounCodeF019=="398", transaction.autCardEntrCapaF22_01=="1", transaction.autRespCodeF039=="155")
then
$record.setCount($record.getCount() + 1);
$measurment.getRecords().put("COUNT_OF_TRANSACTION_ALL_R013", $record);;
update($measurment);
end

rule "(Rule Type COMPUTE) COMPUTE More than 3 transactions by card detected in 3 different countries (Jamaica, UAE, Iraq) within 15min"
no-loop true
lock-on-active true
salience 1000
agenda-group "Card->15 minutes"
when
$measurment: Measurment($record: records.get("COUNT_OF_TRANSACTION_ALL_R021"), $card: transaction.autPrimAcctNumbF002, $country: transaction.autAcqrInstCounCodeF019, ($country=="388" || $country=="466" || $country=="999"))
then
$record.setCount($record.getCount() + 1);
$measurment.getRecords().put("COUNT_OF_TRANSACTION_ALL_R021", $record);;
update($measurment);
end

rule "(Rule Type ALERT) ALERT More than 3 Cash Disbursement ATM transactions  by card detected in 3 different countries (Jordan, Kazakhstan, Morocco)  within 1hour"
no-loop true

salience 200
agenda-group "Card->1 hour"
when
$measurment: Measurment($record: records.get("COUNT_OF_TRANSACTION_ALL_R018"), $card: transaction.autPrimAcctNumbF002, $record.count>=3L)
then
messageSender.send("Alert: More than 3L Cash Disbursement ATM transactions by card " + $card + " detected in 3 different countries (Jordan, Kazakhstan, Morocco) within 1 hour(s)",Alert.POSITIVE);
update($measurment);
end

rule "(Rule Type COMPUTE) COMPUTE More than 20 transactions by card  detected in 4 different countries (Jordan, Kazakhstan, UAE, Morocco) within 1 week"
no-loop true
lock-on-active true
salience 1000
agenda-group "Card->7 days"
when
$measurment: Measurment($record: records.get("COUNT_OF_TRANSACTION_ALL_R022"), $card: transaction.autPrimAcctNumbF002, $country: transaction.autAcqrInstCounCodeF019, ($country=="400" || $country=="398" || $country=="466" || $country=="504"))
then
$record.setCount($record.getCount() + 1);
$measurment.getRecords().put("COUNT_OF_TRANSACTION_ALL_R022", $record);;
update($measurment);
end

rule "(Rule Type COMPUTE) COMPUTE PIN Try Limit Exceeded ON Salary Withdrawal POS (Morocco)"
no-loop true
lock-on-active true
salience 1000
agenda-group "Card->15 minutes"
when
$measurment: Measurment($record: records.get("COUNT_OF_TRANSACTION_ALL_R015"), $merchant: transaction.merchant, transaction.merchant==$merchant, transaction.autTranCode=="7007", transaction.autMercTypeF018=="3260", transaction.autAcqrInstCounCodeF019=="504", transaction.autCardEntrCapaF22_01=="1", transaction.autTranCurrF049=="504", transaction.autRespCodeF039=="275")
then
$record.setCount($record.getCount() + 1);
$measurment.getRecords().put("COUNT_OF_TRANSACTION_ALL_R015", $record);;
update($measurment);
end

rule "(Rule Type COMPUTE) COMPUTE More than 40 transactions with Response Code 155 (PIN Error)  of type 7007 (Salary Withdrawal POS) at MCC 3260 (Spirit Air) in United Arab Emirates (466) using Puce within 3 months."
no-loop true
lock-on-active true
salience 1000
agenda-group "Card->3 months"
when
$measurment: Measurment($record: records.get("COUNT_OF_TRANSACTION_ALL_R014"), $merchant: transaction.merchant, transaction.merchant==$merchant, transaction.autTranCode=="7007", transaction.autMercTypeF018=="3260", transaction.autAcqrInstCounCodeF019=="466", transaction.autCardEntrCapaF22_01=="1", transaction.autRespCodeF039=="155")
then
$record.setCount($record.getCount() + 1);
$measurment.getRecords().put("COUNT_OF_TRANSACTION_ALL_R014", $record);;
update($measurment);
end

rule "(Rule Type COMPUTE) COMPUTE More than 10 Cash Disbursement ATM transactions  detected in multiple countries within 5 HOURS"
no-loop true
lock-on-active true
salience 1000
agenda-group "Card->5 hours"
when
$measurment: Measurment($record: records.get("COUNT_OF_TRANSACTION_ALL_R017"), $country: transaction.autAcqrInstCounCodeF019, transaction.autTranCode=="7000", ($country=="466", $country=="398" && $country=="999"))
then
$record.setCount($record.getCount() + 1);
$measurment.getRecords().put("COUNT_OF_TRANSACTION_ALL_R017", $record);;
update($measurment);
end

rule "(Rule Type COMPUTE) COMPUTE NUMBER OF TRX IN DIFFERENT COUNTRIES WITHIN 5 hour(s)"
no-loop true
lock-on-active true
salience 1000
agenda-group "Card->5 hours"
when
$measurment: Measurment($country: lasts.get("COUNTRY"), $country!=null, $country!=transaction.country, $record: records.get("COUNT_OF_COUNTRY_CHANGES"))
then
$record.setCount($record.getCount() + 1);
$measurment.getRecords().put("COUNT_OF_COUNTRY_CHANGES", $record);;
$measurment.getLasts().put("COUNTRY",$measurment.getTransaction().getCountry());
update($measurment);
end

rule "(Rule Type COMPUTE) Initialize rule -> COMPUTE NUMBER OF TRX IN DIFFERENT COUNTRIES WITHIN 5 hour(s)"
no-loop true
lock-on-active true
salience 1000
when
    $measurment: Measurment()
        Measurment($country: lasts.get("COUNTRY"), $country==null)
then
$measurment.getLasts().put("COUNTRY",$measurment.getTransaction().getCountry());
$measurment.setDirty(true);
update($measurment);
end

rule "(Rule Type COMPUTE) COMPUTE NUMBER OF TRANSACTIONS WITH THE SAME MERCHANT WITHIN 1 hour(s)"
no-loop true
lock-on-active true
salience 1000
agenda-group "Card->1 hour"
when
$measurment: Measurment($merchant: transaction.merchant)
    
    eval($merchant != null)
    $key0: String() from "COUNT".concat("_OF").concat("_TRANSACTION").concat("_ALL").concat("_").concat($merchant.toString())
    $record: MeasurmentRecord() from $measurment.getRecords().get($key0)
    Measurment()
then
$record.setCount($record.getCount() + 1);
$measurment.getRecords().put("COUNT_OF_TRANSACTION_ALL_" + $merchant, $record);;
update($measurment);
end

rule "(Rule Type ALERT) ALERT IF THE PERCENTAGE UTILIZATION OF AVAILABLE 'TO SPEND' IN 14 day(s) PERIOD EXCEEDS 60%"
no-loop true

salience 200
agenda-group "Card->14 days"
when
$measurment: Measurment($record: records.get("AMOUNT_OF_TRANSACTION_ALL_TOTAL_PERCENTAGE"), (Double)$record.getValue("percentage")>=0.6)
then
Alert alert = new Alert("Alert: Consumption of available to spend exceeded 0.6 within 14 day(s)",Alert.POSITIVE);
alert.setWeight(100);;
alert.setRuleTitle("ALERT IF THE PERCENTAGE UTILIZATION OF AVAILABLE 'TO SPEND' IN 14 day(s) PERIOD EXCEEDS 60%");;
alert.setTotalAmount($record.getAmount());
alert.setTotalCount($record.getCount());
$measurment.getAlertSet().addAlert(alert);;
update($measurment);
end

rule "(Rule Type ALERT) ALERT More than 10 Cash Disbursement ATM transactions  detected in multiple countries within 5HOURS"
no-loop true

salience 200
agenda-group "Card->5 hours"
when
$measurment: Measurment($record: records.get("COUNT_OF_TRANSACTION_ALL_R017"), $merchant: transaction.merchant, $record.count>=10L)
then
messageSender.send("Alert: More than 10L Cash Disbursement ATM transactions at " + $merchant + ", TranCode=7000, detected in multiple countries (UAE=466, Jordan=400, Iraq=999) within 5 hour(s)",Alert.POSITIVE);
update($measurment);
end

rule "(Rule Type ALERT) ALERT IF TOTAL NUMBER OF POS 02 TRANSACTIONS RECEIVED IN 10 second(s) TIME EXCEEDS 6L"
no-loop true

salience 200
agenda-group "Card->10 seconds"
when
$measurment: Measurment($record: records.get("COUNT_OF_TRANSACTION_ALL_POS02"), $record.count>=6L)
then
Alert alert = new Alert("Alert: Count of POS02 transactions exceeded 6L in 10 second(s) period",Alert.POSITIVE);
alert.setWeight(100);;
alert.setRuleTitle("ALERT IF TOTAL NUMBER OF POS 02 TRANSACTIONS RECEIVED IN 10 second(s) TIME EXCEEDS 6L");;
alert.setTotalAmount($record.getAmount());
alert.setTotalCount($record.getCount());
$measurment.getAlertSet().addAlert(alert);;
update($measurment);
end

rule "(Rule Type COMPUTE) COMPUTE TOTAL AUTHORIZATION VALUE IN 10 minute(s) PERIOD IN [\"0451\", \"0458\", \"0543\"] MCC'S"
no-loop true
lock-on-active true
salience 1000
agenda-group "Card->10 minutes"
when
$measurment: Measurment($record: records.get("AMOUNT_OF_TRANSACTION_ALL_SPECIFICMCC"), $mcc: transaction.mcc, Arrays.asList("0451","0458","0543").contains($mcc))
then
$record.setAmount($record.getAmount() + $measurment.getTransaction().getAmount());
$measurment.getRecords().put("AMOUNT_OF_TRANSACTION_ALL_SPECIFICMCC", $record);;
update($measurment);
end

rule "(Rule Type COMPUTE) COMPUTE NUMBER OF TRANSACTIONS WITH A RESPONSE CODES [\"33\", \"51\", \"54\", \"55\", \"61\", \"65\", \"82\"] WITHIN 10 minute(s)"
no-loop true
lock-on-active true
salience 1000
agenda-group "Card->10 minutes"
when
$measurment: Measurment($record: records.get("COUNT_OF_TRANSACTION_ALL_WITH_SPECIFIC_RESPONSE_CODE"), $respCode: transaction.autRespCodeF039, Arrays.asList("33","51","54","55","61","65","82").contains($respCode), transaction.autMercTypeF018=="6011" || (transaction.autMercTypeF018!="6011" && (transaction.autCardHldrPrscF22_08=="9" || transaction.autCatLevelF22_12=="6")) || (transaction.autMercTypeF018!="6011" && (transaction.autCardHldrPrscF22_08!="9" && transaction.autCatLevelF22_12!="6")))
then
$record.setCount($record.getCount() + 1);
$measurment.getRecords().put("COUNT_OF_TRANSACTION_ALL_WITH_SPECIFIC_RESPONSE_CODE", $record);;
update($measurment);
end

rule "(Rule Type COMPUTE) COMPUTE More than 8 transactions with Response Code 275 (PIN Try Limit Exceeded) of type 7000 (Cash Disbursement ATM) at MCC 6011 (ATM) in Jordan (400) via Payment Channel ATM using Puce within 15 minutes."
no-loop true
lock-on-active true
salience 1000
agenda-group "Card->15 minutes"
when
$measurment: Measurment($record: records.get("COUNT_OF_TRANSACTION_ALL_R011"), $merchant: transaction.merchant, transaction.merchant==$merchant, transaction.autTranCode=="7000", transaction.autMercTypeF018=="6011", transaction.autAcqrInstCounCodeF019=="400", transaction.autCardEntrCapaF22_01=="1", transaction.autRespCodeF039=="275")
then
$record.setCount($record.getCount() + 1);
$measurment.getRecords().put("COUNT_OF_TRANSACTION_ALL_R011", $record);;
update($measurment);
end

rule "(Rule Type COMPUTE) COMPUTE More than 10 transactions by card  detected in 5 different countries (Jordan, Kazakhstan, UAE, Morocco, Bolivia)  within 5hours"
no-loop true
lock-on-active true
salience 1000
agenda-group "Card->5 hours"
when
$measurment: Measurment($record: records.get("COUNT_OF_TRANSACTION_ALL_R020"), $card: transaction.autPrimAcctNumbF002, $country: transaction.autAcqrInstCounCodeF019, ($country=="400" || $country=="398" || $country=="466" || $country=="504" || $country=="068"))
then
$record.setCount($record.getCount() + 1);
$measurment.getRecords().put("COUNT_OF_TRANSACTION_ALL_R020", $record);;
update($measurment);
end

rule "(Rule Type ALERT) ALERT IF TOTAL AUTHORIZATION VALUE EXCEEDS 10000.0 LIMIT IN 10 minute(s) period"
no-loop true

salience 200
agenda-group "Card->10 minutes"
when
$measurment: Measurment($record: records.get("AMOUNT_OF_TRANSACTION_ALL"), $record.amount>=10000.0)
then
Alert alert = new Alert("Alert: Amount of total auth value exceeded 10000.0 in 10 minute(s)",Alert.POSITIVE);
alert.setWeight(200);;
alert.setRuleTitle("ALERT IF TOTAL AUTHORIZATION VALUE EXCEEDS 10000.0 LIMIT IN 10 minute(s) period");;
alert.setTotalAmount($record.getAmount());
alert.setTotalCount($record.getCount());
$measurment.getAlertSet().addAlert(alert);;
update($measurment);
end

rule "(Rule Type ALERT) ALERT IF NUMBER OF TRANSACTIONS WITH THE SAME AMOUNT WITH THE SAME MERCHANT EXCEED 3L within 1 minute(s)"
no-loop true

salience 200
agenda-group "Card->1 minute"
when
$measurment: Measurment($amount: transaction.amount, $merchant: transaction.merchant)
    
    eval($amount != null)
    eval($merchant != null)
    $key0: String() from "COUNT".concat("_OF").concat("_TRANSACTION").concat("_ALL").concat("_").concat($merchant.toString()).concat("_").concat($amount.toString())
    $record: MeasurmentRecord() from $measurment.getRecords().get($key0)
    Measurment($record.count>=3L)
then
Alert alert = new Alert("Alert: More than 3L transactions done with the same amount " + $amount + " and the same merchant " + $merchant + " within 1 minute(s)",Alert.POSITIVE);
alert.setWeight(200);;
alert.setRuleTitle("ALERT IF NUMBER OF TRANSACTIONS WITH THE SAME AMOUNT WITH THE SAME MERCHANT EXCEED 3L within 1 minute(s)");;
alert.setTotalAmount($record.getAmount());
alert.setTotalCount($record.getCount());
$measurment.getAlertSet().addAlert(alert);;
update($measurment);
end

rule "(Rule Type ALERT) ALERT IF THE NUMBER OF TRANSACTIONS WITH A SPECIFIC RESPONSE CODE EXCEED 5L WITHIN 10 minute(s)"
no-loop true

salience 200
agenda-group "Card->10 minutes"
when
$measurment: Measurment($record: records.get("COUNT_OF_TRANSACTION_ALL_WITH_SPECIFIC_RESPONSE_CODE"), $record.count>=5L)
then
Alert alert = new Alert("Alert: Number of transactions with specific response code exceeded 5L within 10 minute(s)",Alert.POSITIVE);
alert.setWeight(300);;
alert.setRuleTitle("ALERT IF THE NUMBER OF TRANSACTIONS WITH A SPECIFIC RESPONSE CODE EXCEED 5L WITHIN 10 minute(s)");;
alert.setTotalAmount($record.getAmount());
alert.setTotalCount($record.getCount());
$measurment.getAlertSet().addAlert(alert);;
update($measurment);
end

rule "(Rule Type ALERT) ALERTMore than 3 transactions by card detected in 3 different countries (Jamaica, UAE, Iraq) within 15min"
no-loop true

salience 200
agenda-group "Card->15 minutes"
when
$measurment: Measurment($record: records.get("COUNT_OF_TRANSACTION_ALL_R021"), $card: transaction.autPrimAcctNumbF002, $record.count>=3L)
then
messageSender.send("Alert: More than 3L transactions by card " + $card + " detected in 3 different countries (Jamaica, UAE, Iraq) within 15 minute(s)",Alert.POSITIVE);
update($measurment);
end

rule "(Rule Type COMPUTE) COMPUTE TOTAL AUTHORIZATION VALUE IN 1 hour(s) IN SPECIFIC COUNTRIES"
no-loop true
lock-on-active true
salience 1000
agenda-group "Card->1 hour"
when
$measurment: Measurment($record: records.get("AMOUNT_OF_TRANSACTION_ALL_SPECIFIC_COUNTRIES"), $country: transaction.country, $country!=null, Arrays.asList("GAB","BOT","KEN").contains($country))
then
$record.setAmount($record.getAmount() + $measurment.getTransaction().getAmount());
$measurment.getRecords().put("AMOUNT_OF_TRANSACTION_ALL_SPECIFIC_COUNTRIES", $record);;
update($measurment);
end

rule "(Rule Type COMPUTE) COMPUTE TOTAL AUTHORIZATION VALUE IN 10 minute(s) period"
no-loop true
lock-on-active true
salience 1000
agenda-group "Card->10 minutes"
when
$measurment: Measurment($record: records.get("AMOUNT_OF_TRANSACTION_ALL"))
then
$record.setAmount($record.getAmount() + $measurment.getTransaction().getAmount());
$measurment.getRecords().put("AMOUNT_OF_TRANSACTION_ALL", $record);;
update($measurment);
end

rule "(Rule Type ALERT) ALERT More than 40 transactions with Response Code 155 (PIN Error)  of type 7007 (Salary Withdrawal POS) at MCC 3260 (Spirit Air) in United Arab Emirates (466) using Puce within 3 months."
no-loop true

salience 200
agenda-group "Card->3 months"
when
$measurment: Measurment($record: records.get("COUNT_OF_TRANSACTION_ALL_R014"), $merchant: transaction.merchant, $record.count>=40L)
then
messageSender.send("Alert: More than 40L transactions with Response Code 155 (PIN Error) at " + $merchant + ", TranCode=7007, MCC=3260 (Spirit Air), Country=UAE (466), Support=Puce within 3 month(s)",Alert.POSITIVE);
update($measurment);
end

rule "(Rule Type ALERT) ALERT More than 5 transactions by card detected in 4 different countries  within 1 day"
no-loop true

salience 200
agenda-group "Card->1 day"
when
$measurment: Measurment($record: records.get("COUNT_OF_TRANSACTION_ALL_R019"), $card: transaction.autPrimAcctNumbF002, $record.count>=5L)
then
messageSender.send("Alert: More than 5L transactions by card " + $card + " detected in 4 different countries (Jordan, UAE, Iraq, Bangladesh) within 1 day(s)",Alert.POSITIVE);
update($measurment);
end

rule "(Rule Type ALERT) ALERT IF TOTAL NUMBER OF INVALID PIN ATTEMPTS EXCEEDS 5L IN 1 minute(s) PERIOD"
no-loop true

salience 200
agenda-group "Card->1 minute"
when
$measurment: Measurment($record: records.get("COUNT_OF_TRANSACTION_ALL_INVALIDPIN_ATTEMPTS"), $record.count>=5L)
then
Alert alert = new Alert("ALERT: Number of invalid PIN attempts exceeded 5L in 1 minute(s)",Alert.POSITIVE);
alert.setWeight(100);;
alert.setRuleTitle("ALERT IF TOTAL NUMBER OF INVALID PIN ATTEMPTS EXCEEDS 5L IN 1 minute(s) PERIOD");;
alert.setTotalAmount($record.getAmount());
alert.setTotalCount($record.getCount());
$measurment.getAlertSet().addAlert(alert);;
update($measurment);
end

rule "(Rule Type ALERT) ALERT More than 70 transactions with Response Code 155 (PIN Error)  of type 5000 (Sales Draft) at MCC 3519 (Pullman International Hotels) in Kazakhstan (398) using Puce within 24 hours."
no-loop true

salience 200
agenda-group "Card->1 day"
when
$measurment: Measurment($record: records.get("COUNT_OF_TRANSACTION_ALL_R013"), $merchant: transaction.merchant, $record.count>=70L)
then
messageSender.send("Alert: More than 70L transactions with Response Code 155 (PIN Error) at " + $merchant + ", TranCode=5000, MCC=3519 (Pullman Hotels), Country=Kazakhstan (398), Support=Puce within 1 day(s)",Alert.POSITIVE);
update($measurment);
end

rule "(Rule Type COMPUTE) COMPUTE THE PERCENTAGE UTILIZATION OF AVAILABLE 'TO SPEND' IN 14 day(s) PERIOD"
no-loop true
lock-on-active true
salience 1000
agenda-group "Card->14 days"
when
$measurment: Measurment($record: records.get("AMOUNT_OF_TRANSACTION_ALL_TOTAL_PERCENTAGE"))
then
$record.putValue("total", (Double)$record.getValue("total")+$measurment.getTransaction().getAmount());
$record.putValue("percentage", (Double)$record.getValue("total")/15000);
update($measurment);
end

rule "(Rule Type COMPUTE) COMPUTE PIN Error sur Cash Disbursement ATM (Dubai, UAE)"
no-loop true
lock-on-active true
salience 1000
agenda-group "Card->1 hour"
when
$measurment: Measurment($record: records.get("COUNT_OF_TRANSACTION_ALL_R016"), $merchant: transaction.merchant, transaction.merchant==$merchant, transaction.autTranCode=="7000", transaction.autMercTypeF018=="6011", transaction.autAcqrInstCounCodeF019=="466", transaction.autCardEntrCapaF22_01=="2", transaction.autRespCodeF039=="155")
then
$record.setCount($record.getCount() + 1);
$measurment.getRecords().put("COUNT_OF_TRANSACTION_ALL_R016", $record);;
update($measurment);
end

rule "(Rule Type COMPUTE) COMPUTE More than 12 transactions with Response Code 161 (Max Transaction Amount Exceeded) of type 5000 (Sales Draft) at MCC 3641 (Sofitel Hotels) in Iraq (999) via Payment Channel online using Contactless within 1 hour."
no-loop true
lock-on-active true
salience 1000
agenda-group "Card->1 hour"
when
$measurment: Measurment($record: records.get("COUNT_OF_TRANSACTION_ALL_R012"), $merchant: transaction.merchant, transaction.merchant==$merchant, transaction.autTranCode=="5000", transaction.autMercTypeF018=="3641", transaction.autAcqrInstCounCodeF019=="999", transaction.autCardEntrCapaF22_01=="3", transaction.autRespCodeF039=="161")
then
$record.setCount($record.getCount() + 1);
$measurment.getRecords().put("COUNT_OF_TRANSACTION_ALL_R012", $record);;
update($measurment);
end


